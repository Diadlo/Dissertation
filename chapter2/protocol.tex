\section{Протокол связи между внедряемой библиотекой и сервером}

Клиент и сервер общаются с помощью специального протокола. В рамках протокола
передаются команды.

\begin{minted}{text}
<команда> ::= <имя-команды> <параметры-команды>
<имя-команды> ::= <строка>
<стока> ::= <длина-строки> <идентификатор>
<длина-строки> ::= uint32_t
<идентификатор> ::= "newApp"
                ::= "setWidgetText"
                ::= "remove"
                ::= "activated"
                ::= "setWidgetWindow"
                ::= "activate"
\end{minted}

Рассмотрим существующие команды:

\subsection{Регистрация приложения}

\textbf{Идентификатор:} «newApp».

\textbf{Праметры:}
\begin{enumerate}
\item идентификатор процесса (8 байт);
\item адрес сокета для общения (строка).
\end{enumerate}

Данная команда посылается от клиента к серверу в самом начале. Серверу
необходимо дифференцировать различные приложения, чтобы корректно посылать
команды.

\subsection{Установка текста элемента}

\textbf{Идентификатор:} «setWidgetText».

\textbf{Праметры:}
\begin{enumerate}
\item идентификатор процесса (8 байт);
\item идентификатор элемента (8 байт);
\item текст элемента (строка).
\end{enumerate}

С помощью данной команды клиент сообщает серверу о добавлении или изменении
текста элемента. Если идентификатор уже использовался, то считается, что текст
элемента изменился, иначе, что элемент только добавлен.

\subsection{Удаление элемента}

\textbf{Идентификатор:} «remove».

\textbf{Праметры:}
\begin{enumerate}
\item идентификатор процесса (8 байт);
\item идентификатор элемента (8 байт).
\end{enumerate}

Используется, когда клиент считает, что элемент больше не доступен для
активации. После выполнения данной команды, сервер должен перестать выдавать
элемент в списке с запросом всех доступных элементов. Идентификатор считается
свободным и может быть повторно использован для новых элементов.

\subsection{Сообщение об активации окна}

\textbf{Идентификатор:} «activated».

\textbf{Праметры:}
\begin{enumerate}
\item идентификатор процесса (8 байт);
\item идентификатор окна (4 байта).
\end{enumerate}

Клиент посылает данную команду, когда сменилось активное окно в приложении. Это
требуется для того, чтобы сервер мог позже вернуться к последнему активному
окну. Идентификатор окна представляет собой аттрибут \textit{windowId} окна
системы X11. Сервер должен использовать его для последнующей работы с окном.

\subsection{Привязка элемента к окну}

\textbf{Идентификатор:} «setWidgetWindow».

\textbf{Праметры:}
\begin{enumerate}
\item идентификатор процесса (8 байт);
\item идентификатор элемента (8 байт);
\item идентификатор окна (4 байта).
\end{enumerate}

Некоторые приложения могут создавать элементы, которые не привязаны к
конкретному окну, а привязывать их позже. Или перемещать существующие элементы
между окнами в целях оптимизации. Клиент должен посылать данную команду, чтобы
сообщить серверу, что конкретный элемент относится к конкретному окну. Серверу
это нужно, чтобы понимать, какие элементы доступны в текущем окне.

\subsection{Активация элемента}

\textbf{Идентификатор:} «activate».

\textbf{Праметры:}
\begin{enumerate}
\item идентификатор элемента (8 байт);
\end{enumerate}

Эта команда посылается от сервера клиенту, чтобы активировать элемент (нажать
кнопку, открыть меню и т.п.)

\subsection{Обработка ошибок}

В случае, если в любой команде, которая использует идентификатор элемента,
приходит значение, которое не было зарегистрировано или было удално, сервер
должен проигнорировать команду.
